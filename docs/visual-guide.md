# IOPub Message Broker - Visual Guide

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kernel Process                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    IOPub XPUB Socket                     â”‚   â”‚
â”‚  â”‚  (Broadcasts all execution events, streams, errors...)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ ZeroMQ
                            â”‚ Messages
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Carpo Frontend Process                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              IOPub SUB Socket (Iopub)                    â”‚   â”‚
â”‚  â”‚             (Receives all messages)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           IOPub Thread (iopub_thread.rs)                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ Loop:                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   1. msg = iopub.recv_timeout(100ms)             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   2. broker.route_message(msg)                    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚   3. Periodic cleanup every 30s                   â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              IopubBroker (broker.rs)                     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ Active Requests (HashMap<RequestId, Context>)     â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ "req-001" â†’ RequestContext {                â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   started_at: Instant                       â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   channels: {                               â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     status_tx    â†’ [Busy, Idle]            â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     execution_tx â†’ [ExecuteInput, Result]  â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     stream_tx    â†’ [stdout, stderr]        â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     display_tx   â†’ [plots, images]         â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚     comm_tx      â†’ [widget messages]       â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   }                                         â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ }                                           â”‚  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ "req-002" â†’ RequestContext { ... }            â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚  â”‚                                                    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ Global Subscribers (Vec<Sender<Message>>)         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Monitoring/logging channels                    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Stream aggregators                             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚                                                    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ Orphan Buffer (VecDeque<(Message, Instant)>)      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Messages without matching requests             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  - Max 1000 messages, 60s retention              â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚               â”‚                       â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚          â–¼                                            â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Global Subscriber â”‚                      â”‚ Request Chan â”‚   â”‚
â”‚  â”‚   (e.g. logger)   â”‚                      â”‚   Receivers  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚           â”‚
â”‚                                                     â–¼           â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                          â”‚ execute_code()   â”‚   â”‚
â”‚                                          â”‚  Collects msgs   â”‚   â”‚
â”‚                                          â”‚  Returns result  â”‚   â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Message Flow Example

### Scenario: Execute "print('hello')"

```
Timeline:

T=0ms   â”‚ User calls execute_code("print('hello')")
        â”‚
        â”œâ”€â–º 1. Create channels for this request
        â”‚   (status_tx/rx, execution_tx/rx, stream_tx/rx, display_tx/rx, comm_tx/rx)
        â”‚
        â”œâ”€â–º 2. Shell sends execute_request
        â”‚   msg_id: "abc-123"
        â”‚   code: "print('hello')"
        â”‚
        â”œâ”€â–º 3. Broker registers request
        â”‚   active_requests["abc-123"] = RequestContext { channels, ... }
        â”‚
        â–¼

T=5ms   â”‚ Kernel receives request on Shell socket
        â”‚ Starts execution
        â”‚
        â”œâ”€â–º IOPub broadcasts: Status { state: Busy, parent: "abc-123" }
        â”‚
        â–¼

T=7ms   â”‚ IOPub thread receives Status message
        â”‚
        â”œâ”€â–º broker.route_message(Status { ... })
        â”‚   
        â”œâ”€â–º Extract parent_id: "abc-123"
        â”‚   
        â”œâ”€â–º Find matching request in active_requests
        â”‚   
        â”œâ”€â–º Route to status_tx channel
        â”‚   
        â–¼

T=8ms   â”‚ execute_code() receives from status_rx
        â”‚ âœ“ Confirms Busy status
        â”‚
        â–¼

T=10ms  â”‚ Kernel broadcasts: ExecuteInput { code: "print('hello')", parent: "abc-123" }
        â”‚
        â–¼

T=12ms  â”‚ IOPub thread routes to execution_tx
        â”‚
        â–¼

T=13ms  â”‚ execute_code() receives from execution_rx
        â”‚ âœ“ Confirms code matches
        â”‚
        â–¼

T=15ms  â”‚ Kernel executes code, prints to stdout
        â”‚
        â”œâ”€â–º IOPub broadcasts: Stream { name: "stdout", text: "hello\n", parent: "abc-123" }
        â”‚
        â–¼

T=17ms  â”‚ IOPub thread routes to stream_tx
        â”‚
        â–¼

T=18ms  â”‚ execute_code() receives from stream_rx (drains channel)
        â”‚
        â–¼

T=20ms  â”‚ Kernel finishes execution
        â”‚
        â”œâ”€â–º IOPub broadcasts: Status { state: Idle, parent: "abc-123" }
        â”‚
        â–¼

T=22ms  â”‚ IOPub thread routes to status_tx
        â”‚
        â–¼

T=23ms  â”‚ execute_code() receives from status_rx
        â”‚ âœ“ Sees Idle, breaks loop
        â”‚
        â”œâ”€â–º Shell receives execute_reply
        â”‚   
        â”œâ”€â–º broker.unregister_request("abc-123")
        â”‚   (Removes from active_requests)
        â”‚
        â””â”€â–º Returns result to user
```

## Message Routing Decision Tree

```
Message arrives from IOPub
    â”‚
    â”œâ”€â–º Send to ALL global subscribers (clone)
    â”‚
    â”œâ”€â–º Extract parent_header.msg_id
    â”‚   â”‚
    â”‚   â”œâ”€â–º Has parent_id?
    â”‚   â”‚   â”‚
    â”‚   â”‚   YESâ”€â”€â–º Find in active_requests?
    â”‚   â”‚   â”‚      â”‚
    â”‚   â”‚   â”‚      YESâ”€â”€â–º Route by message type:
    â”‚   â”‚   â”‚      â”‚      â”œâ”€ Status        â†’ status_tx
    â”‚   â”‚   â”‚      â”‚      â”œâ”€ ExecuteResult â†’ execution_tx
    â”‚   â”‚   â”‚      â”‚      â”œâ”€ ExecuteError  â†’ execution_tx
    â”‚   â”‚   â”‚      â”‚      â”œâ”€ ExecuteInput  â†’ execution_tx
    â”‚   â”‚   â”‚      â”‚      â”œâ”€ Stream        â†’ stream_tx
    â”‚   â”‚   â”‚      â”‚      â”œâ”€ DisplayData   â†’ display_tx
    â”‚   â”‚   â”‚      â”‚      â””â”€ CommMsg       â†’ comm_tx
    â”‚   â”‚   â”‚      â”‚
    â”‚   â”‚   â”‚      NOâ”€â”€â–º Add to orphan buffer
    â”‚   â”‚   â”‚             (might be late or early)
    â”‚   â”‚   â”‚
    â”‚   â”‚   NOâ”€â”€â–º Add to orphan buffer
    â”‚   â”‚          (no parent = global event)
    â”‚   â”‚
    â”‚   â””â”€â–º Message consumed âœ“
```

## Cleanup Process

```
Every 30 seconds (configurable):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  broker.cleanup()                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  1. Cleanup Stale Requests              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ For each request:              â”‚  â”‚
â”‚     â”‚   if now - started_at > 5min   â”‚  â”‚
â”‚     â”‚     remove from active_requestsâ”‚  â”‚
â”‚     â”‚     log warning                â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  2. Cleanup Orphan Messages             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ For each orphan:               â”‚  â”‚
â”‚     â”‚   if now - timestamp > 60s     â”‚  â”‚
â”‚     â”‚     remove from buffer         â”‚  â”‚
â”‚     â”‚     log trace                  â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  3. Log Statistics                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ Active requests: N             â”‚  â”‚
â”‚     â”‚ Orphan messages: M             â”‚  â”‚
â”‚     â”‚ Global subscribers: K          â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Concurrent Execution Example

```
Multiple requests can be active simultaneously:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IopubBroker                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Active Requests:                                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ "req-001" (Python: import pandas)               â”‚    â”‚
â”‚  â”‚   started: T+0ms                                â”‚    â”‚
â”‚  â”‚   channels: â†’ Thread 1                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ "req-002" (Python: df.head())                   â”‚    â”‚
â”‚  â”‚   started: T+10ms                               â”‚    â”‚
â”‚  â”‚   channels: â†’ Thread 2                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ "req-003" (Python: plt.plot())                  â”‚    â”‚
â”‚  â”‚   started: T+20ms                               â”‚    â”‚
â”‚  â”‚   channels: â†’ Thread 3                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Each request's messages are isolated:
  - req-001 messages â†’ Thread 1's channels
  - req-002 messages â†’ Thread 2's channels  
  - req-003 messages â†’ Thread 3's channels

No cross-contamination! ğŸ¯
```

## Memory Layout

```
IopubBroker                            ~80 bytes
  â”‚
  â”œâ”€â–º active_requests: RwLock<HashMap>  ~48 bytes + content
  â”‚   â”‚
  â”‚   â””â”€â–º Per request:                  ~200 bytes
  â”‚       - RequestId (String)          ~24 bytes
  â”‚       - Instant                     ~16 bytes
  â”‚       - 5 x Sender<Message>         ~160 bytes
  â”‚
  â”œâ”€â–º global_subscribers: RwLock<Vec>   ~48 bytes + content
  â”‚   â”‚
  â”‚   â””â”€â–º Per subscriber:               ~32 bytes
  â”‚       - Sender<Message>
  â”‚
  â”œâ”€â–º orphan_buffer: Mutex<VecDeque>    ~48 bytes + content
  â”‚   â”‚
  â”‚   â””â”€â–º Per message:                  ~500-2000 bytes
  â”‚       - Message (varies by type)
  â”‚       - Instant                     ~16 bytes
  â”‚
  â””â”€â–º config: BrokerConfig              ~48 bytes

Typical memory usage:
  - Base:                    ~224 bytes
  - 10 active requests:      ~2 KB
  - 100 orphan messages:     ~50-200 KB
  - 5 global subscribers:    ~160 bytes
  
Total: ~2.5-202.5 KB (minimal overhead)
```
