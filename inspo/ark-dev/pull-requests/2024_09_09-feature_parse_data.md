# Add `ParseData` type

> <https://github.com/posit-dev/ark/pull/508>
>
> * Author: @lionel-
> * State: MERGED
> * Labels:

This new type wraps the data frame of parse information generated by the R parser when:

- A source file environment is provided to the parser (which is the case at R level when `getOption("keep.source")` is `TRUE`).
- `getOption("keep.parse.data")` is `TRUE` (the default).

This parse data is interesting for the task of determining expression boundaries in a string because it is written by the parser even in the case of an incomplete or invalid input. Unfortunately there is no information about parse failures that we can use, but knowing the boundaries of valid expressions will prove very useful as it allows the following strategy:

- Use parse data to figure out boundaries of complete expressions.
- If there was an error, do a binary search with `R_ParseVector()` to figure out the boundaries of incomplete and invalid inputs in the last expression.

Progress towards posit-dev/positron#1326.

This work is supported by the following infrastructure improvements that are also part of this PR:

- New `DataFrame` type that validates its input. Once constructed, the following guarantees are provided:
    - List storage and `"data.frame"` class
    - Dimensions and valid names
    - All columns are vectors and the same size as the data frame

- There is a new `Error::MissingColumnError` returned from `DataFrame::col()` when an expected column is missing.

- New `harp::assert_class()` returns a new `Error::UnexpectedClass`.

- New `harp::unreachable!()` macro returns an `Error::AnyhowError`.

- New `.inherits()`, `.class()`, and `.dim()` methods for `RObject`.

- New coercion methods from `&RObject` to `Vec<T>` used to validate column types. These use a generic helper. I tried to integrate this helper in the `Vector` trait but couldn't solve compiler errors. Alternatively we could generate them with `vector_macros` but unless it saves a of work or substantially reduces the chance of undry typos we're probably better off with explicit code.

- The `iter()` method is no longer generated by `vector_macros`, it's now part of the `Vector` trait. This allows generic implementations to create vector iterators.

- The `TryFrom` methods for `SEXP -> impl Vector` now create empty vectors if passed `NULL`. This in turn is used in `&RObject -> Vec<T>` (this was necessary because the existing conversion method for `RObject -> Vec<i32>` now uses the new helper for `&RObject` and it supports `NULL` inputs, which seems reasonable enough for a conversion method).

